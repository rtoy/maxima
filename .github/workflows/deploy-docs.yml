name: GitHub Actions Deploy
run-name: ${{ github.actor }} is running Deploy CI üöÄ
on: [push, workflow_dispatch]
jobs:
  build-docs:
    runs-on: ubuntu-24.04
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v4
      - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "üñ•Ô∏è The workflow is now ready to test your code on the runner."
      - name: Update OS and get tools
        run: |
          sudo apt-get update
          # Cmucl needs 32-bit libs to run
          sudo apt-get install gcc-multilib
          # texlive for latex so we can build the pdf manual.
          # texlive-plain-generic to get epsf.sty that's needed by the
          # manual.
          sudo apt-get install texlive texlive-plain-generic
      - name: Install cmucl
        # cmucl is installed cmucl in the current directory
        run: |
          wget -nv https://common-lisp.net/project/cmucl/downloads/snapshots/2024/04/cmucl-2024-04-x86-linux.tar.bz2
          mkdir cmucl 
          tar -C cmucl -xjf cmucl-2024-04-x86-linux.tar.bz2
      - name: Configure Maxima
        run: |
          ./bootstrap
          ./configure --enable-cmucl --with-cmucl=$PWD/cmucl/bin/lisp
      # Need to build maxima so we can build the index.  Without this
      # we fail to build the docs.
      - name: Build Maxima with cmucl
        run: |
          make -C src cmucl
      # The user manual needs to be built before the tests are run
      # because there a test for the user manual.
      - name: Build user manual
        run: |
          make -C doc/info
          make -C doc/info pdf
      - name:  Copy docs
        run: |
          mkdir docs || true
          cp doc/info/maxima.info* doc/info/maxima.pdf doc/info/*.html _site/docs
      - name: Archive user manual
        # uses: actions/upload-artifact@v4
        uses: actions/upload-pages-artifact@v3
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-24.04
    permissions:
      pages: write
      id-token: write
    needs: build-docs
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
  
